<template>
  <div class="dot-wrapper">
    <canvas ref="canvas" class="dot-canvas"></canvas>
    <div class="controls">
      <button @click="setShape('circle')">Circles</button>
      <button @click="setShape('heart')">Hearts</button>
      <button @click="setShape('text')">Text</button>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';

const canvas = ref(null);
let ctx;
const dots = [];
const numDots = 800;
const radius = 1.2;
let shapePositions = [];
let currentShape = 'random';
const mouse = { x: null, y: null };
let hue = 0; // for rainbow color cycling

// Generates shape positions
function getShapePositions(shapeType) {
  const tempCanvas = document.createElement('canvas');
  const tempCtx = tempCanvas.getContext('2d');
  tempCanvas.width = canvas.value.width;
  tempCanvas.height = canvas.value.height;

  tempCtx.fillStyle = '#fff';
  tempCtx.textAlign = 'center';
  tempCtx.textBaseline = 'middle';

  if (shapeType === 'circle') {
    const numCircles = 30;
    for (let i = 0; i < numCircles; i++) {
      const cx = Math.random() * canvas.value.width;
      const cy = Math.random() * canvas.value.height;
      const r = 15 + Math.random() * 4;
      tempCtx.beginPath();
      tempCtx.arc(cx, cy, r, 0, Math.PI * 2);
      tempCtx.fill();
    }
  } else if (shapeType === 'heart') {
    const numHearts = 50;
    for (let i = 0; i < numHearts; i++) {
      const x = Math.random() * canvas.value.width;
      const y = Math.random() * canvas.value.height;
      const size = 2 + Math.random() * 3;
      for (let t = 0; t < Math.PI * 2; t += 0.03) {
        const hx = 16 * Math.pow(Math.sin(t), 3);
        const hy =
          13 * Math.cos(t) -
          5 * Math.cos(2 * t) -
          2 * Math.cos(3 * t) -
          Math.cos(4 * t);
        tempCtx.fillRect(x + hx * size, y - hy * size, 2, 2);
      }
    }
  } else if (shapeType === 'text') {
    tempCtx.font = 'bold 70px Arial';
    tempCtx.fillText('MOTHEO MORENA', canvas.value.width / 2, canvas.value.height - 50);
  }

  const data = tempCtx.getImageData(0, 0, canvas.value.width, canvas.value.height).data;
  const positions = [];
  for (let y = 0; y < canvas.value.height; y += 6) {
    for (let x = 0; x < canvas.value.width; x += 6) {
      const index = (y * canvas.value.width + x) * 4;
      if (data[index + 3] > 128) positions.push({ x, y });
    }
  }
  return positions;
}

// Assign target positions
function setShape(shapeType) {
  currentShape = shapeType;
  shapePositions = getShapePositions(shapeType);
  for (let i = 0; i < dots.length; i++) {
    const pos = shapePositions[i % shapePositions.length];
    dots[i].tx = pos.x;
    dots[i].ty = pos.y;
  }
}

// Animate the colour animation :)
function animate() {
  ctx.fillStyle = 'rgba(0, 0, 0, 0.08)';
  ctx.fillRect(0, 0, canvas.value.width, canvas.value.height);

  hue += 2;
  if (hue > 360) hue = 0;

  dots.forEach((d) => {
    d.x += (d.tx - d.x) * d.speed;
    d.y += (d.ty - d.y) * d.speed;

    // check if near mouse
    let color = '#eae1fc53';
    if (mouse.x && mouse.y) {
      const dx = d.x - mouse.x;
      const dy = d.y - mouse.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < 100) {
        const localHue = (hue + dist) % 360;
        color = `hsl(${localHue}, 100%, 65%)`; // rainbow glow
      }
    }

    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(d.x, d.y, radius, 0, Math.PI * 2);
    ctx.fill();
  });

  requestAnimationFrame(animate);
}

onMounted(() => {
  const el = canvas.value;
  el.width = window.innerWidth;
  el.height = window.innerHeight;
  ctx = el.getContext('2d');

  for (let i = 0; i < numDots; i++) {
    dots.push({
      x: Math.random() * el.width,
      y: Math.random() * el.height,
      tx: Math.random() * el.width,
      ty: Math.random() * el.height,
      speed: 0.03 + Math.random() * 0.04,
    });
  }

  animate();

  window.addEventListener('mousemove', (e) => {
    mouse.x = e.clientX;
    mouse.y = e.clientY;
  });

  window.addEventListener('mouseleave', () => {
    mouse.x = null;
    mouse.y = null;
  });

  window.addEventListener('resize', () => {
    el.width = window.innerWidth;
    el.height = window.innerHeight;
    if (currentShape !== 'random') setShape(currentShape);
  });
});
</script>

<style scoped>
.dot-wrapper {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: auto;
  z-index: 0;
}

.dot-canvas {
  width: 100%;
  height: 100%;
  display: block;
  background: transparent;
}

.controls {
  position: fixed;
  top: 50%;
  left: 10px;
  transform: translateY(-50%);
  z-index: 1;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  pointer-events: auto;
}

button {
  padding: 8px 14px;
  font-size: 16px;
  font-weight: bold;
  border: none;
  background: rgba(30, 29, 29, 0.7);
  border: 1px ridge rgba(128, 0, 128, 0.6);
  color: #fff;
  cursor: pointer;
  border-radius: 6px;
  transition: background 0.3s, transform 0.2s;
}
button:hover {
  background: #9d4edd;
  transform: scale(1.05);
}
</style>